#!/usr/bin/env python
import os
import sys
import json
import argparse
import configparser


PACKAGE_PARENT = '..'
SCRIPT_DIR = os.path.dirname(os.path.realpath(os.path.join(os.getcwd(), os.path.expanduser(__file__))))
sys.path.append(os.path.normpath(os.path.join(SCRIPT_DIR, PACKAGE_PARENT)) + '/')

import hephaestus


parser = argparse.ArgumentParser(description="Start Queue Consumer", prog=hephaestus.__title__)

parser.add_argument('--version', action='version', version='%(prog)s v' + hephaestus.__version__)
parser.add_argument('-c', '--config',
                    dest="config",
                    action='store',
                    default='/etc/hephaestus/config.conf',
                    help='Absolute path to configuration file')
parser.add_argument('-k', '--aws-key',
                    dest="aws_key",
                    action='store',
                    help='AWS Key')
parser.add_argument('-s', '--aws-secret',
                    dest="aws_secret",
                    action='store',
                    help='AWS Secret')
parser.add_argument('-r', '--aws-region',
                    dest="aws_region",
                    action='store',
                    help='AWS Region')
parser.add_argument('-q', '--sqs-queue-name',
                    dest="queue_name",
                    action='store',
                    help='SQS Queue Name')
parser.add_argument('-v', '--visibility-timeout',
                    dest="visibility_timeout",
                    action='store',
                    help='SQS Visibility Timeout')
parser.add_argument('-m', '--max-number-of-messages',
                    dest="max_number_of_messages",
                    action='store',
                    help='Max Number of Mesages to get per request to SQS')
parser.add_argument('-t', '--wait-time-seconds',
                    dest="wait_time_seconds",
                    action='store',
                    help='Enables long polling to SQS. Value specifies how long to wait for new messages')
parser.add_argument('-w', '--queue-workers',
                    dest="queue_workers",
                    action='store',
                    help='Number of SQS message fetching threads to spawn')
parser.add_argument('-mw', '--message-processor-workers',
                    dest="message_processor_workers",
                    action='store',
                    help='Number of message processor threads to spawn')
parser.add_argument('-qs', '--message-queue-max-size',
                    dest="message_queue_max_size",
                    action='store',
                    help='Max size of message queue from which message processor threads pick up messages')


args = parser.parse_args()

from hephaestus.conf import settings, load_transport
from hephaestus import worker


def set_config(config):

    def get_config(key, config_section_key, config_get_type=None):
        arg = getattr(args, key, None)
        if arg:
            if config_get_type:
                return config_get_type(arg)
            else:
                return arg
        config_section = config[config_section_key]

        if not config_get_type:
            return config_section.get(key)
        elif config_get_type == int:
            return config_section.getint(key)

    setattr(settings, 'AWS_KEY', get_config('aws_key', 'AWS_CREDENTIALS'))
    setattr(settings, 'AWS_SECRET', get_config('aws_secret', 'AWS_CREDENTIALS'))
    setattr(settings, 'AWS_REGION', get_config('aws_region', 'AWS_CREDENTIALS'))

    setattr(settings, 'SQS_QUEUE_NAME', get_config('queue_name', 'SQS_SETTINGS'))
    setattr(settings, 'SQS_VISIBILITY_TIMEOUT', get_config('visibility_timeout', 'SQS_SETTINGS', int))
    setattr(settings, 'SQS_MAX_NUMBER_MESSAGES', get_config('max_number_of_messages', 'SQS_SETTINGS', int))
    setattr(settings, 'SQS_WAIT_TIME_SECONDS', get_config('wait_time_seconds', 'SQS_SETTINGS', int))

    setattr(settings, 'QUEUE_WORKERS', get_config('queue_workers', 'WORKER_SETTINGS', int))
    setattr(settings, 'MESSAGE_PROCESSOR_WORKERS', get_config('message_processor_workers', 'WORKER_SETTINGS', int))
    setattr(settings, 'MESSAGE_QUEUE_MAX_SIZE', get_config('message_queue_max_size', 'WORKER_SETTINGS', int))


def set_message_processors(config):
    location = config['GENERAL']
    message_transport_conf = json.load(open(location.get('message_transport_conf')))
    Transport = load_transport(message_transport_conf['type'])
    transport = Transport(conf=message_transport_conf)
    transport.load()
    return transport


if __name__ == '__main__':
    config = configparser.ConfigParser()
    config.read(args.config)
    set_config(config)
    transport = set_message_processors(config)
    worker.start_workers(transport=transport)
